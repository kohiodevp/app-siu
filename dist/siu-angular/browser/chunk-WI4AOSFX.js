import{d as le}from"./chunk-3GNZGIER.js";import{d as re}from"./chunk-WO6PXY3V.js";import{a as Ht,b as qt}from"./chunk-MRX5LSGG.js";import{c as Ut}from"./chunk-HZBF5Z2J.js";import"./chunk-PQNUUMDX.js";import{a as Gt,b as Kt,c as Qt,d as Yt,e as Wt,f as Xt,g as Zt,h as te,i as ee,j as ne,l as ie}from"./chunk-3DRFPNYN.js";import{a as ae,b as oe}from"./chunk-TUX7OWEK.js";import"./chunk-7UZYWCAJ.js";import{c as et,d as z,g as D,h as nt,i as it}from"./chunk-OCAOS45R.js";import{d as $t,h as zt,i as jt}from"./chunk-M2B5FNU7.js";import{b as Jt,f as Bt}from"./chunk-TC4NHXKF.js";import"./chunk-CVA3OUYK.js";import{b as Et,c as At}from"./chunk-E7OICD5F.js";import{a as Dt}from"./chunk-OFBHONAA.js";import{b as Mt,e as wt,i as Ot}from"./chunk-YPBVTN56.js";import{a as kt,b as Lt}from"./chunk-3WYC6ROS.js";import"./chunk-AC4QEAXS.js";import"./chunk-QLHDTFGW.js";import{a as Rt}from"./chunk-TAVIRTLO.js";import{a as Nt}from"./chunk-RSTPHI64.js";import{a as Vt,b as Ft}from"./chunk-XMY2MG46.js";import"./chunk-QDNYLZKO.js";import{a as L,b as j,c as U,d as St,f as J,h as S}from"./chunk-FY6NZ6SC.js";import{b as ft,g as ht,h as _t,k as Ct,m as xt,n as bt,s as vt,u as yt}from"./chunk-4TEKNYBZ.js";import{a as V,b as F}from"./chunk-UUJ2B6HP.js";import{$ as Tt,W as Pt,Y as It}from"./chunk-AQZ5PN4T.js";import{A as gt,p as y,u as pt,v as ut}from"./chunk-3AYM6UTQ.js";import{Cb as p,D as rt,Db as u,Gb as X,H as lt,Hb as Z,Ib as g,Jb as a,Kb as i,Lb as _,Pb as w,Qb as O,S as R,Sb as $,Wb as C,Xa as l,Y as st,Yb as d,ac as dt,ba as P,bc as ct,c as W,cc as mt,e as ot,ga as I,ha as T,hc as k,jc as N,kc as o,lb as b,lc as m,mc as f,nc as tt,rb as v,sa as x,tc as h}from"./chunk-E7AQ6X4Y.js";import{a as Q,b as Y}from"./chunk-EQDQRRRY.js";var B=class n{constructor(){this.http=P(ut);this.apiUrl=`${gt.apiUrl}/api/audit`}getAuditLogs(t={}){let e=new pt;return Object.entries(t).forEach(([r,s])=>{s!=null&&(e=e.set(r,s.toString()))}),this.http.get(`${this.apiUrl}/logs`,{params:e})}getEntityHistory(t,e,r=50){return this.http.get(`${this.apiUrl}/entity/${t}/${e}`,{params:{limit:r.toString()}})}getUserActions(t,e=30,r=100){return this.http.get(`${this.apiUrl}/user/${t}`,{params:{days:e.toString(),limit:r.toString()}})}getAuditStats(t=30){return this.http.get(`${this.apiUrl}/stats`,{params:{days:t.toString()}})}searchLogs(t,e=100){return this.http.get(`${this.apiUrl}/search`,{params:{q:t,limit:e.toString()}})}exportCSV(t=7){return this.http.get(`${this.apiUrl}/export/csv`,{params:{days:t.toString()},responseType:"blob"})}exportJSON(t=7){return this.http.get(`${this.apiUrl}/export/json`,{params:{days:t.toString()},responseType:"blob"})}downloadCSV(t=7){return new W(e=>{this.exportCSV(t).subscribe({next:r=>{let s=window.URL.createObjectURL(r),c=document.createElement("a");c.href=s,c.download=`audit_logs_${new Date().toISOString().split("T")[0]}.csv`,c.click(),window.URL.revokeObjectURL(s),e.next(),e.complete()},error:r=>e.error(r)})})}downloadJSON(t=7){return new W(e=>{this.exportJSON(t).subscribe({next:r=>{let s=window.URL.createObjectURL(r),c=document.createElement("a");c.href=s,c.download=`audit_logs_${new Date().toISOString().split("T")[0]}.json`,c.click(),window.URL.revokeObjectURL(s),e.next(),e.complete()},error:r=>e.error(r)})})}cleanupOldLogs(t=365){return this.http.delete(`${this.apiUrl}/cleanup`,{params:{days_to_keep:t.toString()}})}getRelativeTime(t){let e=new Date,r=new Date(t),s=e.getTime()-r.getTime(),c=Math.floor(s/6e4),E=Math.floor(s/36e5),A=Math.floor(s/864e5);return c<1?"\xC0 l'instant":c<60?`Il y a ${c} min`:E<24?`Il y a ${E}h`:A<7?`Il y a ${A}j`:r.toLocaleDateString("fr-FR")}getActionLabel(t){return{create:"Cr\xE9ation",read:"Consultation",update:"Modification",delete:"Suppression",login:"Connexion",logout:"D\xE9connexion",export:"Export",import:"Import",upload:"Upload",download:"T\xE9l\xE9chargement",validate:"Validation",assign:"Attribution"}[t]||t}getEntityLabel(t){return{user:"Utilisateur",parcel:"Parcelle",document:"Document",owner:"Propri\xE9taire",alert:"Alerte",system:"Syst\xE8me"}[t]||t}getActionIcon(t){return{create:"add_circle",read:"visibility",update:"edit",delete:"delete",login:"login",logout:"logout",export:"download",import:"upload",upload:"cloud_upload",download:"cloud_download",validate:"check_circle",assign:"person_add"}[t]||"circle"}getStatusColor(t){return{success:"#4caf50",failure:"#f44336",pending:"#ff9800"}[t]||"#9e9e9e"}static{this.\u0275fac=function(e){return new(e||n)}}static{this.\u0275prov=st({token:n,factory:n.\u0275fac,providedIn:"root"})}};function pe(n,t){if(n&1&&(a(0,"div",6),o(1),i()),n&2){let e=d();l(),m(e.subtitle)}}function ue(n,t){if(n&1&&(a(0,"div",8)(1,"mat-icon",9),o(2),i(),a(3,"span",10),o(4),i(),a(5,"span",11),o(6,"vs 7 jours pr\xE9c\xE9dents"),i()()),n&2){let e=d();N("trend-"+e.trend.direction),l(2),f(" ",e.trend.direction==="up"?"trending_up":e.trend.direction==="down"?"trending_down":"trending_flat"," "),l(2),f("",e.trend.percentage,"%")}}var q=class n{constructor(){this.label="";this.value=0;this.icon="bar_chart";this.color="#673ab7"}getIconBackground(){return this.hexToRgba(this.color,.1)}hexToRgba(t,e){let r=parseInt(t.slice(1,3),16),s=parseInt(t.slice(3,5),16),c=parseInt(t.slice(5,7),16);return`rgba(${r}, ${s}, ${c}, ${e})`}static{this.\u0275fac=function(e){return new(e||n)}}static{this.\u0275cmp=b({type:n,selectors:[["app-stats-card"]],inputs:{label:"label",value:"value",icon:"icon",color:"color",trend:"trend",subtitle:"subtitle"},decls:12,vars:12,consts:[[1,"stats-card"],[1,"stats-card-content"],[1,"stats-icon"],[1,"stats-details"],[1,"stats-label"],[1,"stats-value"],[1,"stats-subtitle"],[1,"stats-trend",3,"class"],[1,"stats-trend"],[1,"trend-icon"],[1,"trend-value"],[1,"trend-label"]],template:function(e,r){e&1&&(a(0,"mat-card",0)(1,"div",1)(2,"div",2)(3,"mat-icon"),o(4),i()(),a(5,"div",3)(6,"div",4),o(7),i(),a(8,"div",5),o(9),i(),p(10,pe,2,1,"div",6),p(11,ue,7,4,"div",7),i()()()),e&2&&(N("stats-card-"+r.color),g("@countUp",void 0),l(2),k("background",r.getIconBackground()),l(),k("color",r.color),l(),m(r.icon),l(3),m(r.label),l(2),m(r.value),l(),u(r.subtitle?10:-1),l(),u(r.trend?11:-1))},dependencies:[y,S,L,F,V],styles:[".stats-card[_ngcontent-%COMP%]{height:100%;cursor:pointer;transition:transform .3s cubic-bezier(.4,0,.2,1),box-shadow .3s cubic-bezier(.4,0,.2,1)}.stats-card[_ngcontent-%COMP%]:hover{transform:translateY(-4px);box-shadow:0 8px 24px #00000026}.stats-card-content[_ngcontent-%COMP%]{display:flex;gap:1rem;padding:1rem}.stats-icon[_ngcontent-%COMP%]{width:64px;height:64px;border-radius:12px;display:flex;align-items:center;justify-content:center;flex-shrink:0}.stats-icon[_ngcontent-%COMP%]   mat-icon[_ngcontent-%COMP%]{font-size:32px;width:32px;height:32px}.stats-details[_ngcontent-%COMP%]{flex:1;display:flex;flex-direction:column;gap:.25rem}.stats-label[_ngcontent-%COMP%]{font-size:.875rem;color:var(--text-secondary);font-weight:500;text-transform:uppercase;letter-spacing:.5px}.stats-value[_ngcontent-%COMP%]{font-size:2rem;font-weight:700;line-height:1.2;color:var(--text-primary)}.stats-subtitle[_ngcontent-%COMP%]{font-size:.75rem;color:var(--text-secondary);margin-top:.25rem}.stats-trend[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.25rem;margin-top:.5rem;font-size:.75rem;font-weight:600}.trend-icon[_ngcontent-%COMP%]{font-size:18px;width:18px;height:18px}.trend-up[_ngcontent-%COMP%]{color:#4caf50}.trend-down[_ngcontent-%COMP%]{color:#f44336}.trend-stable[_ngcontent-%COMP%]{color:#9e9e9e}.trend-label[_ngcontent-%COMP%]{color:var(--text-secondary);font-weight:400;margin-left:.25rem}@media(max-width:768px){.stats-icon[_ngcontent-%COMP%]{width:48px;height:48px}.stats-icon[_ngcontent-%COMP%]   mat-icon[_ngcontent-%COMP%]{font-size:24px;width:24px;height:24px}.stats-value[_ngcontent-%COMP%]{font-size:1.5rem}}"],data:{animation:[et("countUp",[it(":enter",[D({opacity:0,transform:"scale(0.8)"}),z("500ms cubic-bezier(0.35, 0, 0.25, 1)",D({opacity:1,transform:"scale(1)"}))])]),et("pulse",[nt("up",D({transform:"scale(1)"})),nt("down",D({transform:"scale(1)"})),it("* => up",[z("300ms",D({transform:"scale(1.1)"})),z("300ms",D({transform:"scale(1)"}))])])]},changeDetection:0})}};var ge=["chart"],M=()=>({}),ce=()=>[];function fe(n,t){if(n&1&&(a(0,"mat-card-subtitle"),o(1),i()),n&2){let e=d(2);l(),m(e.subtitle)}}function he(n,t){if(n&1&&(a(0,"mat-card-header")(1,"mat-card-title"),o(2),i(),p(3,fe,2,1,"mat-card-subtitle"),i()),n&2){let e=d();l(2),m(e.title),l(),u(e.subtitle?3:-1)}}var G=class n{constructor(){this.type="bar";this.data=[];this.labels=[];this.colors=["#673ab7","#3f51b5","#2196f3","#00bcd4","#009688"];this.height=350}ngOnInit(){this.initializeChart()}initializeChart(){let t=window.matchMedia("(prefers-color-scheme: dark)").matches,e={series:this.getSeries(),chart:{type:this.type,height:this.height,toolbar:{show:!0,tools:{download:!0,selection:!1,zoom:!1,zoomin:!1,zoomout:!1,pan:!1,reset:!1}},animations:{enabled:!0,speed:800,animateGradually:{enabled:!0,delay:150},dynamicAnimation:{enabled:!0,speed:350}},background:"transparent",foreColor:t?"#ffffff":"#373d3f"},colors:this.colors,dataLabels:{enabled:!1},legend:{position:"bottom",horizontalAlign:"center",fontSize:"14px",markers:{strokeWidth:0}},tooltip:{theme:t?"dark":"light",y:{formatter:r=>r.toString()}}};this.type==="pie"||this.type==="donut"?this.chartOptions=Y(Q({},e),{labels:this.labels,plotOptions:{pie:{donut:{size:this.type==="donut"?"65%":"0%",labels:{show:!0,total:{show:!0,label:"Total",formatter:r=>r.globals.seriesTotals.reduce((s,c)=>s+c,0).toString()}}}}}}):this.chartOptions=Y(Q({},e),{xaxis:{categories:this.labels,labels:{style:{fontSize:"12px"}}},yaxis:{labels:{style:{fontSize:"12px"}}},stroke:{curve:this.type==="line"||this.type==="area"?"smooth":"straight",width:this.type==="line"||this.type==="area"?3:0},fill:{type:this.type==="area"?"gradient":"solid",gradient:{shadeIntensity:1,opacityFrom:.7,opacityTo:.3,stops:[0,90,100]}},plotOptions:{bar:{borderRadius:4,columnWidth:"60%",dataLabels:{position:"top"}}}})}getSeries(){return this.type==="pie"||this.type==="donut"?this.data:[{name:this.title||"Data",data:this.data}]}static{this.\u0275fac=function(e){return new(e||n)}}static{this.\u0275cmp=b({type:n,selectors:[["app-chart-card"]],viewQuery:function(e,r){if(e&1&&dt(ge,5),e&2){let s;ct(s=mt())&&(r.chart=s.first)}},inputs:{title:"title",subtitle:"subtitle",type:"type",data:"data",labels:"labels",colors:"colors",height:"height"},decls:4,vars:23,consts:[[1,"chart-card"],[3,"series","chart","xaxis","yaxis","dataLabels","stroke","plotOptions","legend","labels","colors","fill","tooltip"]],template:function(e,r){e&1&&(a(0,"mat-card",0),p(1,he,4,2,"mat-card-header"),a(2,"mat-card-content"),_(3,"apx-chart",1),i()()),e&2&&(l(),u(r.title?1:-1),l(2),g("series",r.chartOptions.series)("chart",r.chartOptions.chart)("xaxis",r.chartOptions.xaxis||h(13,M))("yaxis",r.chartOptions.yaxis||h(14,M))("dataLabels",r.chartOptions.dataLabels||h(15,M))("stroke",r.chartOptions.stroke||h(16,M))("plotOptions",r.chartOptions.plotOptions||h(17,M))("legend",r.chartOptions.legend||h(18,M))("labels",r.chartOptions.labels||h(19,ce))("colors",r.chartOptions.colors||h(20,ce))("fill",r.chartOptions.fill||h(21,M))("tooltip",r.chartOptions.tooltip||h(22,M)))},dependencies:[y,S,L,U,J,St,j,qt,Ht],styles:[".chart-card[_ngcontent-%COMP%]{height:100%;display:flex;flex-direction:column}mat-card-content[_ngcontent-%COMP%]{flex:1;padding:1rem}  .apexcharts-canvas{margin:0 auto}"],changeDetection:0})}};var _e=(n,t)=>t.key,Ce=(n,t)=>t.field;function xe(n,t){if(n&1&&(a(0,"div",1)(1,"div",4)(2,"h4")(3,"mat-icon",5),o(4,"remove_circle"),i(),o(5," Avant "),i(),a(6,"pre",6),o(7),i()(),a(8,"div",7)(9,"h4")(10,"mat-icon",5),o(11,"add_circle"),i(),o(12," Apr\xE8s "),i(),a(13,"pre",6),o(14),i()()()),n&2){let e=d();l(7),m(e.formatJSON(e.oldData)),l(7),m(e.formatJSON(e.newData))}}function be(n,t){if(n&1&&(a(0,"div",13)(1,"div",16)(2,"span",17),o(3,"Ancien :"),i(),a(4,"code"),o(5),i()(),a(6,"mat-icon",18),o(7,"arrow_downward"),i(),a(8,"div",19)(9,"span",17),o(10,"Nouveau :"),i(),a(11,"code"),o(12),i()()()),n&2){let e=d().$implicit,r=d(2);l(5),m(r.formatValue(e.oldValue)),l(7),m(r.formatValue(e.newValue))}}function ve(n,t){if(n&1&&(a(0,"div",14)(1,"code"),o(2),i()()),n&2){let e=d().$implicit,r=d(2);l(2),m(r.formatValue(e.newValue))}}function ye(n,t){if(n&1&&(a(0,"div",15)(1,"code"),o(2),i()()),n&2){let e=d().$implicit,r=d(2);l(2),m(r.formatValue(e.oldValue))}}function Se(n,t){if(n&1&&(a(0,"div",9)(1,"div",10)(2,"mat-icon",11),o(3),i(),a(4,"span",12),o(5),i()(),p(6,be,13,2,"div",13)(7,ve,3,1,"div",14)(8,ye,3,1,"div",15),i()),n&2){let e=t.$implicit;N("diff-"+e.type),l(3),f(" ",e.type==="added"?"add":e.type==="removed"?"remove":"edit"," "),l(2),m(e.key),l(),u(e.type==="modified"?6:e.type==="added"?7:e.type==="removed"?8:-1)}}function Me(n,t){if(n&1&&(a(0,"div",2),X(1,Se,9,5,"div",8,_e),i()),n&2){let e=d();l(),Z(e.getInlineDiff())}}function we(n,t){if(n&1&&(a(0,"div",20)(1,"span",21),o(2),i(),a(3,"div",22)(4,"span",16),o(5),i(),a(6,"mat-icon"),o(7,"arrow_forward"),i(),a(8,"span",19),o(9),i()()()),n&2){let e=t.$implicit,r=d(2);l(2),m(e.field),l(3),m(r.formatValue(e.old)),l(4),m(r.formatValue(e.new))}}function Oe(n,t){if(n&1&&(a(0,"div",3),X(1,we,10,3,"div",20,Ce),i()),n&2){let e=d();l(),Z(e.getChangesArray())}}var K=class n{constructor(){this.oldData=null;this.newData=null;this.viewMode="changes-only"}formatJSON(t){return t?JSON.stringify(t,null,2):"N/A"}formatValue(t){return t==null?"N/A":typeof t=="object"?JSON.stringify(t):String(t)}getChangesArray(){return this.changes?Object.entries(this.changes).map(([t,e])=>({field:t,old:e.old,new:e.new})):[]}getInlineDiff(){let t=[];if(!this.oldData&&!this.newData)return t;let e=new Set(this.oldData?Object.keys(this.oldData):[]),r=new Set(this.newData?Object.keys(this.newData):[]);return new Set([...e,...r]).forEach(c=>{let E=e.has(c),A=r.has(c);E&&!A?t.push({key:c,type:"removed",oldValue:this.oldData[c]}):!E&&A?t.push({key:c,type:"added",newValue:this.newData[c]}):E&&A&&this.oldData[c]!==this.newData[c]&&t.push({key:c,type:"modified",oldValue:this.oldData[c],newValue:this.newData[c]})}),t}static{this.\u0275fac=function(e){return new(e||n)}}static{this.\u0275cmp=b({type:n,selectors:[["app-json-diff-viewer"]],inputs:{oldData:"oldData",newData:"newData",changes:"changes",viewMode:"viewMode"},decls:4,vars:1,consts:[[1,"json-diff-viewer"],[1,"side-by-side"],[1,"inline-diff"],[1,"changes-only"],[1,"column","old-column"],[1,"column-icon"],[1,"json-content"],[1,"column","new-column"],[1,"diff-item",3,"class"],[1,"diff-item"],[1,"diff-header"],[1,"diff-icon"],[1,"field-name"],[1,"diff-values"],[1,"added-value"],[1,"removed-value"],[1,"old-value"],[1,"value-label"],[1,"arrow-icon"],[1,"new-value"],[1,"change-row"],[1,"change-field"],[1,"change-comparison"]],template:function(e,r){e&1&&(a(0,"div",0),p(1,xe,15,2,"div",1)(2,Me,3,0,"div",2)(3,Oe,3,0,"div",3),i()),e&2&&(l(),u(r.viewMode==="side-by-side"?1:r.viewMode==="inline"?2:r.viewMode==="changes-only"?3:-1))},dependencies:[y,S,F,V,re],styles:[".json-diff-viewer[_ngcontent-%COMP%]{width:100%}.side-by-side[_ngcontent-%COMP%]{display:grid;grid-template-columns:1fr 1fr;gap:1rem}.column[_ngcontent-%COMP%]   h4[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.5rem;margin:0 0 .5rem;padding:.5rem;border-radius:4px}.old-column[_ngcontent-%COMP%]   h4[_ngcontent-%COMP%]{background:#f443361a;color:#f44336}.new-column[_ngcontent-%COMP%]   h4[_ngcontent-%COMP%]{background:#4caf501a;color:#4caf50}.column-icon[_ngcontent-%COMP%]{font-size:20px;width:20px;height:20px}.json-content[_ngcontent-%COMP%]{background:var(--bg-secondary);padding:1rem;border-radius:4px;overflow-x:auto;font-family:Courier New,monospace;font-size:.875rem;line-height:1.5;color:var(--text-primary);white-space:pre-wrap;word-break:break-word}.inline-diff[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.5rem}.diff-item[_ngcontent-%COMP%]{padding:.75rem;border-radius:4px;border-left:3px solid}.diff-added[_ngcontent-%COMP%]{background:#4caf500d;border-color:#4caf50}.diff-removed[_ngcontent-%COMP%]{background:#f443360d;border-color:#f44336}.diff-modified[_ngcontent-%COMP%]{background:#ff98000d;border-color:#ff9800}.diff-header[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.5rem;margin-bottom:.5rem}.diff-icon[_ngcontent-%COMP%]{font-size:18px;width:18px;height:18px}.diff-added[_ngcontent-%COMP%]   .diff-icon[_ngcontent-%COMP%]{color:#4caf50}.diff-removed[_ngcontent-%COMP%]   .diff-icon[_ngcontent-%COMP%]{color:#f44336}.diff-modified[_ngcontent-%COMP%]   .diff-icon[_ngcontent-%COMP%]{color:#ff9800}.field-name[_ngcontent-%COMP%]{font-weight:600;color:var(--text-primary)}.diff-values[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.5rem;padding-left:1.5rem}.old-value[_ngcontent-%COMP%], .new-value[_ngcontent-%COMP%], .added-value[_ngcontent-%COMP%], .removed-value[_ngcontent-%COMP%]{padding:.5rem;border-radius:4px;font-family:Courier New,monospace;font-size:.875rem}.old-value[_ngcontent-%COMP%]{background:#f443361a;border-left:2px solid #f44336}.new-value[_ngcontent-%COMP%], .added-value[_ngcontent-%COMP%]{background:#4caf501a;border-left:2px solid #4caf50}.removed-value[_ngcontent-%COMP%]{background:#f443361a;border-left:2px solid #f44336;text-decoration:line-through}.value-label[_ngcontent-%COMP%]{font-weight:600;margin-right:.5rem;font-family:sans-serif}.arrow-icon[_ngcontent-%COMP%]{font-size:20px;width:20px;height:20px;color:var(--text-secondary);align-self:center}.changes-only[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.75rem}.change-row[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.5rem;padding:.75rem;background:var(--bg-secondary);border-radius:4px}.change-field[_ngcontent-%COMP%]{font-weight:600;color:var(--text-primary)}.change-comparison[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.5rem}.change-comparison[_ngcontent-%COMP%]   .old-value[_ngcontent-%COMP%], .change-comparison[_ngcontent-%COMP%]   .new-value[_ngcontent-%COMP%]{flex:1}@media(max-width:768px){.side-by-side[_ngcontent-%COMP%]{grid-template-columns:1fr}.change-comparison[_ngcontent-%COMP%]{flex-direction:column;align-items:stretch}.arrow-icon[_ngcontent-%COMP%]{transform:rotate(90deg)}}"],changeDetection:0})}};var De=()=>[10,25,50,100];function Ee(n,t){n&1&&(a(0,"div",6),_(1,"mat-spinner",7),a(2,"p"),o(3,"Chargement des donn\xE9es d'audit..."),i()())}function Ae(n,t){if(n&1&&_(0,"app-chart-card",14),n&2){let e=d(2);g("data",e.actionChartData().data)("labels",e.actionChartData().labels)("height",300)}}function Pe(n,t){if(n&1&&_(0,"app-chart-card",15),n&2){let e=d(2);g("data",e.entityChartData().data)("labels",e.entityChartData().labels)("height",300)}}function Ie(n,t){n&1&&(a(0,"th",52),o(1,"Date"),i())}function Te(n,t){if(n&1&&(a(0,"td",53),o(1),i()),n&2){let e=t.$implicit,r=d(2);l(),f(" ",r.formatDate(e.timestamp)," ")}}function ke(n,t){n&1&&(a(0,"th",52),o(1,"Action"),i())}function Le(n,t){if(n&1&&(a(0,"td",53)(1,"mat-chip")(2,"mat-icon"),o(3),i(),o(4),i()()),n&2){let e=t.$implicit,r=d(2);l(),k("background-color",r.getActionColor(e.action)),l(2),m(r.getActionIcon(e.action)),l(),f(" ",r.getActionLabel(e.action)," ")}}function Ve(n,t){n&1&&(a(0,"th",52),o(1,"Entit\xE9"),i())}function Fe(n,t){if(n&1&&(a(0,"span",54),o(1),i()),n&2){let e=d().$implicit;l(),f("#",e.entity_id)}}function Ne(n,t){if(n&1&&(a(0,"td",53),o(1),p(2,Fe,2,1,"span",54),i()),n&2){let e=t.$implicit,r=d(2);l(),f(" ",r.getEntityLabel(e.entity_type)," "),l(),u(e.entity_id?2:-1)}}function Re(n,t){n&1&&(a(0,"th",52),o(1,"Utilisateur"),i())}function $e(n,t){if(n&1&&(a(0,"td",53),o(1),i()),n&2){let e=t.$implicit;l(),f(" ",e.username||"Syst\xE8me"," ")}}function ze(n,t){n&1&&(a(0,"th",52),o(1,"Statut"),i())}function je(n,t){if(n&1&&(a(0,"td",53)(1,"mat-icon"),o(2),i()()),n&2){let e=t.$implicit,r=d(2);l(),k("color",r.getStatusColor(e.status)),l(),f(" ",e.status==="success"?"check_circle":"error"," ")}}function Ue(n,t){n&1&&(a(0,"th",52),o(1,"D\xE9tails"),i())}function Je(n,t){if(n&1){let e=$();a(0,"td",53)(1,"button",55),C("click",function(){let s=I(e).$implicit,c=d(2);return T(c.viewDetails(s))}),a(2,"mat-icon"),o(3,"visibility"),i()()()}}function Be(n,t){n&1&&_(0,"tr",56)}function He(n,t){n&1&&_(0,"tr",57)}function qe(n,t){if(n&1&&(a(0,"h4"),o(1,"Modifications"),i(),_(2,"app-json-diff-viewer",62)),n&2){let e=d(3);l(2),g("changes",e.selectedLog().changes)}}function Ge(n,t){if(n&1&&(a(0,"div",61)(1,"mat-icon"),o(2,"error"),i(),a(3,"span"),o(4),i()()),n&2){let e=d(3);l(4),m(e.selectedLog().error_message)}}function Ke(n,t){if(n&1){let e=$();a(0,"mat-card",51)(1,"mat-card-header")(2,"mat-card-title"),o(3),i(),a(4,"button",58),C("click",function(){I(e);let s=d(2);return T(s.closeDetails())}),a(5,"mat-icon"),o(6,"close"),i()()(),a(7,"mat-card-content")(8,"div",59)(9,"div",60)(10,"strong"),o(11,"Date:"),i(),a(12,"span"),o(13),i()(),a(14,"div",60)(15,"strong"),o(16,"Utilisateur:"),i(),a(17,"span"),o(18),i()(),a(19,"div",60)(20,"strong"),o(21,"IP:"),i(),a(22,"span"),o(23),i()(),a(24,"div",60)(25,"strong"),o(26,"Dur\xE9e:"),i(),a(27,"span"),o(28),i()(),a(29,"div",60)(30,"strong"),o(31,"Endpoint:"),i(),a(32,"span"),o(33),i()()(),p(34,qe,3,1),p(35,Ge,5,1,"div",61),i()()}if(n&2){let e=d(2);l(3),f("D\xE9tails du Log #",e.selectedLog().id),l(10),m(e.formatDate(e.selectedLog().timestamp)),l(5),tt("",e.selectedLog().username||"N/A"," (",e.selectedLog().user_role||"N/A",")"),l(5),m(e.selectedLog().user_ip||"N/A"),l(5),f("",e.selectedLog().duration_ms||0," ms"),l(5),tt("",e.selectedLog().request_method," ",e.selectedLog().request_path),l(),u(e.selectedLog().changes?34:-1),l(),u(e.selectedLog().error_message?35:-1)}}function Qe(n,t){if(n&1){let e=$();a(0,"div",8),_(1,"app-stats-card",9)(2,"app-stats-card",10)(3,"app-stats-card",11)(4,"app-stats-card",12),i(),a(5,"div",13),p(6,Ae,1,3,"app-chart-card",14),p(7,Pe,1,3,"app-chart-card",15),i(),a(8,"mat-card",16)(9,"mat-card-header")(10,"mat-card-title"),o(11,"Filtres"),i()(),a(12,"mat-card-content")(13,"form",17)(14,"mat-form-field",18)(15,"mat-label"),o(16,"Recherche"),i(),_(17,"input",19),a(18,"mat-icon",20),o(19,"search"),i()(),a(20,"mat-form-field",18)(21,"mat-label"),o(22,"Action"),i(),a(23,"mat-select",21)(24,"mat-option",22),o(25,"Toutes"),i(),a(26,"mat-option",23),o(27,"Cr\xE9ation"),i(),a(28,"mat-option",24),o(29,"Modification"),i(),a(30,"mat-option",25),o(31,"Suppression"),i(),a(32,"mat-option",26),o(33,"Connexion"),i(),a(34,"mat-option",27),o(35,"D\xE9connexion"),i()()(),a(36,"mat-form-field",18)(37,"mat-label"),o(38,"Entit\xE9"),i(),a(39,"mat-select",28)(40,"mat-option",22),o(41,"Toutes"),i(),a(42,"mat-option",29),o(43,"Parcelle"),i(),a(44,"mat-option",30),o(45,"Document"),i(),a(46,"mat-option",31),o(47,"Utilisateur"),i(),a(48,"mat-option",32),o(49,"Propri\xE9taire"),i()()(),a(50,"mat-form-field",18)(51,"mat-label"),o(52,"Statut"),i(),a(53,"mat-select",33)(54,"mat-option",22),o(55,"Tous"),i(),a(56,"mat-option",34),o(57,"Succ\xE8s"),i(),a(58,"mat-option",35),o(59,"\xC9chec"),i()()(),a(60,"button",3),C("click",function(){I(e);let s=d();return T(s.applyFilters())}),a(61,"mat-icon"),o(62,"filter_list"),i(),o(63," Appliquer "),i(),a(64,"button",36),C("click",function(){I(e);let s=d();return T(s.resetFilters())}),a(65,"mat-icon"),o(66,"clear"),i(),o(67," R\xE9initialiser "),i()()()(),a(68,"mat-card",37)(69,"mat-card-header")(70,"mat-card-title"),o(71),i()(),a(72,"mat-card-content")(73,"div",38)(74,"table",39),w(75,40),v(76,Ie,2,0,"th",41)(77,Te,2,1,"td",42),O(),w(78,43),v(79,ke,2,0,"th",41)(80,Le,5,4,"td",42),O(),w(81,44),v(82,Ve,2,0,"th",41)(83,Ne,3,2,"td",42),O(),w(84,45),v(85,Re,2,0,"th",41)(86,$e,2,1,"td",42),O(),w(87,46),v(88,ze,2,0,"th",41)(89,je,3,3,"td",42),O(),w(90,47),v(91,Ue,2,0,"th",41)(92,Je,4,0,"td",42),O(),v(93,Be,1,0,"tr",48)(94,He,1,0,"tr",49),i()(),a(95,"mat-paginator",50),C("page",function(s){I(e);let c=d();return T(c.onPageChange(s))}),i()()(),p(96,Ke,36,10,"mat-card",51)}if(n&2){let e,r,s=d();l(),g("value",((e=s.stats())==null?null:e.total)||0),l(),g("value",s.getSuccessCount())("subtitle",s.getSuccessRate()+"% de succ\xE8s"),l(),g("value",s.getFailureCount()),l(),g("value",((r=s.stats())==null?null:r.top_users.length)||0),l(2),u(s.actionChartData()?6:-1),l(),u(s.entityChartData()?7:-1),l(6),g("formGroup",s.filterForm),l(58),f("Journal d'Audit (",s.logs().length," r\xE9sultats)"),l(3),g("dataSource",s.logs()),l(19),g("matHeaderRowDef",s.displayedColumns),l(),g("matRowDefColumns",s.displayedColumns),l(),g("length",s.totalLogs())("pageSize",s.pageSize)("pageSizeOptions",h(16,De)),l(),u(s.selectedLog()?96:-1)}}var me=class n{constructor(){this.auditService=P(B);this.fb=P(vt);this.snackBar=P(Vt);this.destroy$=new ot;this.loading=x(!0);this.logs=x([]);this.stats=x(null);this.selectedLog=x(null);this.totalLogs=x(0);this.actionChartData=x(null);this.entityChartData=x(null);this.displayedColumns=["timestamp","action","entity","user","status","actions"];this.pageSize=25;this.currentPage=0;this.filterForm=this.fb.group({search:[""],action:[""],entity_type:[""],status:[""]})}ngOnInit(){this.loadData(),this.setupSearchDebounce()}ngOnDestroy(){this.destroy$.next(),this.destroy$.complete()}loadData(){this.loading.set(!0),this.auditService.getAuditLogs({limit:this.pageSize,offset:this.currentPage*this.pageSize}).pipe(R(this.destroy$)).subscribe({next:t=>{this.logs.set(t.logs),this.totalLogs.set(t.total),this.loading.set(!1)},error:t=>{console.error("Erreur chargement logs:",t),this.loading.set(!1)}}),this.auditService.getAuditStats(30).pipe(R(this.destroy$)).subscribe({next:t=>{this.stats.set(t),this.updateCharts(t)},error:t=>console.error("Erreur chargement stats:",t)})}setupSearchDebounce(){this.filterForm.get("search")?.valueChanges.pipe(rt(500),lt(),R(this.destroy$)).subscribe(t=>{t&&t.length>=2&&this.searchLogs(t)})}updateCharts(t){this.actionChartData.set({labels:Object.keys(t.by_action),data:Object.values(t.by_action)}),this.entityChartData.set({labels:Object.keys(t.by_entity),data:Object.values(t.by_entity)})}applyFilters(){let t=this.filterForm.value;this.auditService.getAuditLogs(t).subscribe(e=>this.logs.set(e.logs))}resetFilters(){this.filterForm.reset(),this.loadData()}searchLogs(t){this.auditService.searchLogs(t).subscribe(e=>this.logs.set(e.results))}onPageChange(t){this.pageSize=t.pageSize,this.currentPage=t.pageIndex,this.loadData()}viewDetails(t){this.selectedLog.set(t)}closeDetails(){this.selectedLog.set(null)}refresh(){this.loadData(),this.snackBar.open("Donn\xE9es actualis\xE9es","Fermer",{duration:2e3})}exportCSV(){this.auditService.downloadCSV(30).subscribe({next:()=>this.snackBar.open("Export CSV r\xE9ussi","Fermer",{duration:2e3}),error:()=>this.snackBar.open("Erreur lors de l'export","Fermer",{duration:3e3})})}exportJSON(){this.auditService.downloadJSON(30).subscribe({next:()=>this.snackBar.open("Export JSON r\xE9ussi","Fermer",{duration:2e3}),error:()=>this.snackBar.open("Erreur lors de l'export","Fermer",{duration:3e3})})}formatDate(t){return new Date(t).toLocaleString("fr-FR")}getActionLabel(t){return this.auditService.getActionLabel(t)}getEntityLabel(t){return this.auditService.getEntityLabel(t)}getActionIcon(t){return this.auditService.getActionIcon(t)}getActionColor(t){return{create:"#4caf50",update:"#2196f3",delete:"#f44336",login:"#ff9800"}[t]||"#9e9e9e"}getStatusColor(t){return this.auditService.getStatusColor(t)}getSuccessCount(){return this.stats()?.by_status.success||0}getFailureCount(){return this.stats()?.by_status.failure||0}getSuccessRate(){let t=this.stats()?.total||0;return t===0?100:Math.round(this.getSuccessCount()/t*100)}static{this.\u0275fac=function(e){return new(e||n)}}static{this.\u0275cmp=b({type:n,selectors:[["app-audit-dashboard"]],decls:20,vars:1,consts:[[1,"audit-dashboard"],[1,"dashboard-header"],[1,"header-actions"],["mat-raised-button","","color","primary",3,"click"],["mat-raised-button","",3,"click"],["mat-icon-button","","matTooltip","Actualiser",3,"click"],[1,"loading-container"],["diameter","64"],[1,"stats-grid"],["label","Total Actions","icon","analytics","color","#673ab7",3,"value"],["label","Actions R\xE9ussies","icon","check_circle","color","#4caf50",3,"value","subtitle"],["label","Actions \xC9chou\xE9es","icon","error","color","#f44336",3,"value"],["label","Utilisateurs Actifs","icon","people","color","#2196f3",3,"value"],[1,"charts-grid"],["title","Actions par Type","type","donut",3,"data","labels","height"],["title","Actions par Entit\xE9","type","bar",3,"data","labels","height"],[1,"filters-card"],[1,"filters-form",3,"formGroup"],["appearance","outline"],["matInput","","formControlName","search","placeholder","Rechercher..."],["matPrefix",""],["formControlName","action"],["value",""],["value","create"],["value","update"],["value","delete"],["value","login"],["value","logout"],["formControlName","entity_type"],["value","parcel"],["value","document"],["value","user"],["value","owner"],["formControlName","status"],["value","success"],["value","failure"],["mat-button","",3,"click"],[1,"logs-card"],[1,"table-container"],["mat-table","",1,"audit-table",3,"dataSource"],["matColumnDef","timestamp"],["mat-header-cell","",4,"matHeaderCellDef"],["mat-cell","",4,"matCellDef"],["matColumnDef","action"],["matColumnDef","entity"],["matColumnDef","user"],["matColumnDef","status"],["matColumnDef","actions"],["mat-header-row","",4,"matHeaderRowDef"],["mat-row","",4,"matRowDef","matRowDefColumns"],[3,"page","length","pageSize","pageSizeOptions"],[1,"details-card"],["mat-header-cell",""],["mat-cell",""],[1,"entity-id"],["mat-icon-button","","matTooltip","Voir d\xE9tails",3,"click"],["mat-header-row",""],["mat-row",""],["mat-icon-button","",3,"click"],[1,"details-grid"],[1,"detail-item"],[1,"error-message"],["viewMode","changes-only",3,"changes"]],template:function(e,r){e&1&&(a(0,"div",0)(1,"div",1)(2,"h1")(3,"mat-icon"),o(4,"security"),i(),o(5," Audit & Tra\xE7abilit\xE9 "),i(),a(6,"div",2)(7,"button",3),C("click",function(){return r.exportCSV()}),a(8,"mat-icon"),o(9,"download"),i(),o(10," Export CSV "),i(),a(11,"button",4),C("click",function(){return r.exportJSON()}),a(12,"mat-icon"),o(13,"code"),i(),o(14," Export JSON "),i(),a(15,"button",5),C("click",function(){return r.refresh()}),a(16,"mat-icon"),o(17,"refresh"),i()()()(),p(18,Ee,4,0,"div",6)(19,Qe,97,17),i()),e&2&&(l(18),u(r.loading()?18:19))},dependencies:[y,yt,Ct,ft,ht,_t,bt,xt,S,L,U,J,j,Tt,It,Pt,F,V,Dt,Ot,Mt,wt,At,Et,jt,zt,$t,le,Ut,ie,Gt,Qt,Zt,Yt,Kt,te,Wt,Xt,ee,ne,oe,ae,Bt,Jt,Rt,Nt,Lt,kt,Ft,q,G,K],styles:[".audit-dashboard[_ngcontent-%COMP%]{padding:1.5rem;max-width:1600px;margin:0 auto}.dashboard-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;margin-bottom:2rem;flex-wrap:wrap;gap:1rem}.dashboard-header[_ngcontent-%COMP%]   h1[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.5rem;margin:0}.header-actions[_ngcontent-%COMP%]{display:flex;gap:.5rem}.loading-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;padding:4rem;gap:1rem}.stats-grid[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1.5rem;margin-bottom:2rem}.charts-grid[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:1.5rem;margin-bottom:2rem}.filters-card[_ngcontent-%COMP%]{margin-bottom:2rem}.filters-form[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;align-items:center}.logs-card[_ngcontent-%COMP%]{margin-bottom:2rem}.table-container[_ngcontent-%COMP%]{overflow-x:auto}.audit-table[_ngcontent-%COMP%]{width:100%}.entity-id[_ngcontent-%COMP%]{color:var(--text-secondary);font-size:.875rem}.details-card[_ngcontent-%COMP%]{position:sticky;bottom:1rem}mat-card-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center}.details-grid[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1rem;margin-bottom:1rem}.detail-item[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.25rem}.detail-item[_ngcontent-%COMP%]   strong[_ngcontent-%COMP%]{color:var(--text-secondary);font-size:.875rem}.error-message[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.5rem;padding:1rem;background:#f443361a;border-left:3px solid #f44336;border-radius:4px;margin-top:1rem}.error-message[_ngcontent-%COMP%]   mat-icon[_ngcontent-%COMP%]{color:#f44336}@media(max-width:768px){.audit-dashboard[_ngcontent-%COMP%]{padding:1rem}.charts-grid[_ngcontent-%COMP%], .filters-form[_ngcontent-%COMP%]{grid-template-columns:1fr}}"],changeDetection:0})}};export{me as AuditDashboardComponent};
