import{c as d}from"./chunk-LMV7XNWS.js";import{a as c}from"./chunk-FBCHPQNP.js";import{B as u,Ec as i,U as s,Y as g,ba as o,l,sa as n}from"./chunk-E7AQ6X4Y.js";var h=class r{constructor(){this.api=o(c);this.router=o(d);this.TOKEN_KEY="siu_auth_token";this.USER_KEY="siu_user";this.currentUserSignal=n(this.loadUserFromStorage());this.tokenSignal=n(this.loadTokenFromStorage());this.currentUser=this.currentUserSignal.asReadonly();this.isAuthenticated=i(()=>this.currentUserSignal()!==null);this.isAdmin=i(()=>this.currentUserSignal()?.is_admin??!1)}login(e){return this.api.post("/auth/login",e).pipe(s(t=>{this.setSession(t),this.router.navigate(["/dashboard"])}))}register(e){return this.api.post("/auth/register",e)}logout(){this.clearSession(),this.router.navigate(["/login"])}getToken(){return this.tokenSignal()}isTokenValid(){let e=this.getToken();if(!e)return!1;try{let t=this.decodeToken(e);return new Date(t.exp*1e3)>new Date}catch(t){return!1}}refreshUser(){return this.api.get("/auth/me").pipe(s(e=>{this.currentUserSignal.set(e),this.saveUserToStorage(e)}),u(()=>(this.logout(),l({}))))}updateCurrentUser(e){this.currentUserSignal.set(e),this.saveUserToStorage(e)}setSession(e){this.tokenSignal.set(e.token),this.currentUserSignal.set(e.user),localStorage.setItem(this.TOKEN_KEY,e.token),this.saveUserToStorage(e.user)}clearSession(){this.tokenSignal.set(null),this.currentUserSignal.set(null),localStorage.removeItem(this.TOKEN_KEY),localStorage.removeItem(this.USER_KEY)}loadTokenFromStorage(){return localStorage.getItem(this.TOKEN_KEY)}loadUserFromStorage(){let e=localStorage.getItem(this.USER_KEY);if(e)try{return JSON.parse(e)}catch(t){return null}return null}saveUserToStorage(e){localStorage.setItem(this.USER_KEY,JSON.stringify(e))}decodeToken(e){let t=e.split(".");if(t.length!==3)throw new Error("Invalid token");let a=t[1],p=atob(a);return JSON.parse(p)}getCurrentUser(){return this.currentUser()}static{this.\u0275fac=function(t){return new(t||r)}}static{this.\u0275prov=g({token:r,factory:r.\u0275fac,providedIn:"root"})}};export{h as a};
